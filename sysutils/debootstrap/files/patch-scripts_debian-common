--- scripts/debian-common.orig	2025-08-27 14:48:00 UTC
+++ scripts/debian-common
@@ -220,10 +220,24 @@ echo \"Warning: Fake start-stop-daemon called, doing n
 		predep=$(without "$(without "$(resolve_deps $predep)" "$required")" "$done_predeps")
 		# XXX: progress is tricky due to how dpkg_progress works
 		# -- cjwatson 2009-07-29
+		# This step sometimes fails due to some missing functionality in Linuxulator.  Just ignore it.
+		set +e
 		p; smallyes '' |
 		in_target dpkg --force-overwrite --force-confold --skip-same-version --install $(debfor $predep)
+		rc=$?
 		base=$(without "$base" "$predep")
 		done_predeps="$done_predeps $predep"
+
+		if [ $rc != 0 ]; then
+			warning FREEBSD_00 "Applying FreeBSD-specific workaround..."
+			# ... for "Failed to mount /etc/machine-id: Bad address" with Focal.
+			in_target truncate -s0 /var/lib/dpkg/info/systemd.postinst
+			# Fix "Failed to take /etc/passwd lock: Invalid argument" error
+			# See: https://github.com/microsoft/WSL/issues/10397#issuecomment-1780132430
+			in_target ln -sf /bin/echo /bin/systemd-sysusers
+			in_target dpkg --configure systemd
+		fi
+		set -e
 	done
 
 	if [ -n "$base" ]; then
@@ -242,6 +256,12 @@ echo \"Warning: Fake start-stop-daemon called, doing n
 
 	mv "$TARGET/sbin/start-stop-daemon.REAL" "$TARGET/sbin/start-stop-daemon"
 	rm -f "$TARGET/usr/sbin/policy-rc.d"
+
+	echo \
+"# Workaround for Linuxulator missing mremap(2) support; without it,
+# apt(8) fails like this:
+# E: Dynamic MMap ran out of room. Please increase the size of APT::Cache-Start.
+APT::Cache-Start 251658240;" >> "$TARGET/etc/apt/apt.conf.d/00freebsd"
 
 	progress $bases $bases CONFBASE "Configuring base system"
 	info BASESUCCESS "Base system installed successfully."
